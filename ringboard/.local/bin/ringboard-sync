#!/bin/bash
# Ringboard sync script with debouncing and offline handling

set -e

RCLONE="$HOME/.local/bin/rclone"
LOCAL_DIR="$HOME/.local/share/ringboard-data"
REMOTE="clipboard-hist:clipboard-history"
LOCK_FILE="/tmp/ringboard-sync.lock"
PENDING_FILE="/tmp/ringboard-sync.pending"
DEBOUNCE_SECONDS=3

# Check if online
is_online() {
    # Try to reach Cloudflare DNS (fast check)
    timeout 2 ping -c 1 1.1.1.1 &>/dev/null
}

# Acquire lock with timeout
acquire_lock() {
    exec 200>"$LOCK_FILE"
    flock -n 200 || return 1
}

# Run sync
do_sync() {
    if ! is_online; then
        echo "Offline - marking sync as pending"
        touch "$PENDING_FILE"
        return 0
    fi

    echo "Syncing to R2..."
    "$RCLONE" bisync "$LOCAL_DIR" "$REMOTE" \
        --create-empty-src-dirs \
        --resilient \
        --recover \
        --conflict-resolve newer \
        2>&1 || {
            # If bisync fails, try regular sync
            echo "Bisync failed, falling back to sync..."
            "$RCLONE" sync "$LOCAL_DIR" "$REMOTE" --create-empty-src-dirs 2>&1
        }

    # Clear pending flag on success
    rm -f "$PENDING_FILE"
    echo "Sync complete"
}

# Main
case "${1:-sync}" in
    sync)
        # Debounce: wait a bit for more changes
        sleep "$DEBOUNCE_SECONDS"

        if acquire_lock; then
            do_sync
        else
            echo "Sync already in progress"
        fi
        ;;
    pending)
        # Called when network comes online
        if [ -f "$PENDING_FILE" ]; then
            echo "Processing pending sync..."
            if acquire_lock; then
                do_sync
            fi
        fi
        ;;
    init)
        # Initialize bisync (first run or recovery)
        "$RCLONE" bisync "$LOCAL_DIR" "$REMOTE" \
            --create-empty-src-dirs \
            --resync
        ;;
    *)
        echo "Usage: $0 {sync|pending|init}"
        exit 1
        ;;
esac
