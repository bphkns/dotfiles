#!/usr/bin/env bash
# lgaicm-commit - Interactive AI commit with fzf
set -euo pipefail

show_help() {
  cat <<EOF
Usage: lgaicm-commit

Interactive AI-assisted commit using fzf for selection.
Requires: lgaicm, fzf, git
EOF
  exit 0
}

[[ "${1:-}" == "-h" || "${1:-}" == "--help" ]] && show_help

# Check dependencies
for cmd in lgaicm fzf git; do
  command -v "$cmd" >/dev/null 2>&1 || { echo "Error: '$cmd' not found" >&2; exit 1; }
done

# Check for staged changes first
if git diff --cached --quiet 2>/dev/null; then
  echo "No staged changes to commit" >&2
  exit 1
fi

# Type selection with fzf (all conventional commit types)
TYPES="AI defined\nfeat\nfix\nchore\nrefactor\ndocs\ntest\nperf\nbuild\nci\nstyle"
TYPE=$(printf "%b" "$TYPES" | fzf --height=40% --reverse --header="Select commit type" --prompt="Type > ") || exit 0

# Convert "AI defined" to empty string
[[ "$TYPE" == "AI defined" ]] && TYPE=""

# Generate commit messages (format: TITLE<TAB>DESCRIPTION with ␤ for newlines)
RAW_MESSAGES=$(lgaicm "$TYPE") || { echo "Failed to generate messages" >&2; exit 1; }

# Extract just titles for fzf display
TITLES=$(echo "$RAW_MESSAGES" | cut -f1)

# Select commit message with fzf
# --print-query outputs: line1=query, line2=selection
# ctrl-e allows custom editing (aborts fzf, uses query as message)
FZF_OUTPUT=$(echo "$TITLES" | fzf --height=40% --reverse --header="Select commit message (ctrl-e to edit)" --prompt="Message > " --bind "ctrl-e:print-query+abort" --print-query 2>/dev/null) || true

# Parse fzf output: prefer selection (line 2), fallback to query (line 1)
QUERY=$(echo "$FZF_OUTPUT" | sed -n '1p')
SELECTION=$(echo "$FZF_OUTPUT" | sed -n '2p')
TITLE="${SELECTION:-$QUERY}"

# Exit if no message
[[ -z "$TITLE" ]] && exit 0

# Find description for selected title
DESC=""
if [[ -n "$SELECTION" ]]; then
  # User selected from list, find matching description (--text forces text mode for special chars)
  DESC=$(echo "$RAW_MESSAGES" | grep -aF "$TITLE" | head -1 | cut -f2 | tr '␤' '\n')
fi

# Confirmation - show both title and description
echo ""
echo -e "\033[1;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
echo -e "\033[1;33m Commit title:\033[0m"
echo -e "\033[1;32m $TITLE\033[0m"
if [[ -n "$DESC" ]]; then
  echo -e "\033[1;33m Description:\033[0m"
  echo -e "\033[0;37m$DESC\033[0m"
fi
echo -e "\033[1;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
echo ""

CONFIRM=$(printf "Yes, commit\nNo, cancel" | fzf --height=20% --reverse --header="Confirm commit?" --prompt="Confirm > ") || exit 0

if [[ "$CONFIRM" == "Yes, commit" ]]; then
  # Commit with title and optional description
  if [[ -n "$DESC" ]]; then
    if git commit -m "$TITLE" -m "$DESC"; then
      echo -e "\n\033[1;32m✓ Committed successfully!\033[0m"
    else
      echo -e "\n\033[1;31m✗ Commit failed\033[0m" >&2
      exit 1
    fi
  else
    if git commit -m "$TITLE"; then
      echo -e "\n\033[1;32m✓ Committed successfully!\033[0m"
    else
      echo -e "\n\033[1;31m✗ Commit failed\033[0m" >&2
      exit 1
    fi
  fi
else
  echo -e "\n\033[1;31m✗ Cancelled\033[0m"
fi
